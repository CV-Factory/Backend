steps:
# Build the container image
- name: 'gcr.io/cloud-builders/docker'
  args: ['build', '-t', 'asia-northeast3-docker.pkg.dev/$PROJECT_ID/cvfactory/cvfactory-server:latest', '.']
# Push the container image to Artifact Registry
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', 'asia-northeast3-docker.pkg.dev/$PROJECT_ID/cvfactory/cvfactory-server:latest']
# Deploy container image to Cloud Run
- name: 'gcr.io/cloud-builders/gcloud'
  entrypoint: 'bash'
  args:
    - '-c'
    - |
      gcloud run deploy cvfactory-server \
        --image asia-northeast3-docker.pkg.dev/$PROJECT_ID/cvfactory/cvfactory-server:latest \
        --region asia-northeast3 \
        --platform managed \
        --allow-unauthenticated \
        --port 8000 \
        --cpu 1 \
        --memory 2Gi \
        --min-instances 0 \
        --max-instances 1 \
        --set-env-vars="PYTHONUNBUFFERED=1,UPSTASH_REDIS_ENDPOINT=gusc1-inviting-kit-31726.upstash.io,UPSTASH_REDIS_PORT=31726" \
        --update-secrets=GROQ_API_KEY=GROQ_API_KEY:latest,COHERE_API_KEY=COHERE_API_KEY:latest,UPSTASH_REDIS_PASSWORD=UPSTASH_REDIS_PASSWORD:latest
images:
- 'asia-northeast3-docker.pkg.dev/$PROJECT_ID/cvfactory/cvfactory-server:latest'
options:
  logging: CLOUD_LOGGING_ONLY 